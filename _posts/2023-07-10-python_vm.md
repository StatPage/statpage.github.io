---
layout: single
title:  "파이썬 가상머신 이해하기"
toc: true
toc_sticky: true
categories: programming
tags: [python, virtual machine]
---

## Intro

이번에 졸업 논문 관련해서 개인적인 프로젝트를 진행 중이다.  
   
정말 감사하게도 매우 대단한 분과 함께 프로젝트를 하게 되어 그 분께 많이 배우고 있는 중이다.  
(이 정도면 프로젝트 하는 것보다 그 분께 배우는 게 더 많을 것 같다는 생각이 들기도 하다)  
   
이 블로그 글도 그 분께 추천 받은 자료로 공학적으로 많이 부족한 나를 위한 자료라 공부한다고 생각하고 추가적으로 설명이 필요한 부분을 보충하면서 썼다.  
   
출처: [http://jasonleaster.github.io/2016/02/21/architecture-of-python-virtual-machine/#Executing-environment-in-Python-VM](http://jasonleaster.github.io/2016/02/21/architecture-of-python-virtual-machine/#Executing-environment-in-Python-VM)

# 파이썬 Virtual Machine

파이썬 Virtual machine(VM)은 파이썬의 핵심이다.

우선 Virtual Machine 구조를 내가 이해한 대로 정리해보자면,

컴퓨터에서 계산기 프로그램을 작동하려면 그에 맞는 소프트웨어를 돌린다.

가상 머신 또한 마찬가지로 컴퓨터 내에서 가상의 컴퓨터 작동에 필요한 소프트웨어를 돌린다.

그럼 이 때 가상의 컴퓨터가 이해하는 언어로 명령을 해야 하고 이게 바로 Opcode다.

파이썬 코드를 작동시키면, `compile()` 함수가 파이썬 코드를 컴파일하여, 해당 코드를 나타내는 `code` 객체를 생성한다. 이 `code` 객체는 `PyCodeObject` 구조체를 가지고 있다.

   
파이썬 코드를 Opcode(byte code) 명령어들의 집합으로 이루어진 code 객체로 컴파일링을 하면, 파이썬 Virtual Machine은 나머지 작업을 한다.

(파이썬 명령어 → 가상 컴퓨터(머신) 명령어 → 컴퓨터 명령어: 이로 인해 파이썬의 이식성이 높아진다.)  
 

### _Opcode는_

> 바이트 코드(byte code) 명령어를 나타내는 축약어로, 파이썬 VM에서 실행되는 명령어다. 파이썬 코드를 컴파일하면 바이트 코드 형태로 변환되고, 이 바이트 코드가 파이썬 가상 머신에서 실행된다. (파이썬 코드 컴파일 → 바이트 코드(opcode) → 실행 in 파이썬 VM)  
> 각각의 바이트 코드는 파이썬 인터프리터가 실행할 수 있는 작은 명령어로, 파이썬 코드의 구성 요소인 변수, 함수, 클래스 등을 나타내며 파이썬 VM이 해당 코드를 실행하는 데 필요한 정보를 포함하고 있다.

   
파이썬 VM이 opcode를 가져와 해당 코드를 실행할 때 각 opcode를 읽고 적절한 작업을 수행한다.  
 

간단한 예를 들어보면, 파이썬 코드에서 "1+2"라는 연산을 수행하려면, 이 코드를 파이썬 가상 머신에서 실행하면, 먼저 `compile` 함수를 사용하여 해당 코드를 `code` 객체로 컴파일해야 한다. 이 `code` 객체는 opcode 명령어들의 집합으로 이루어져 있다.

   
이 opcode는 실제로 두 숫자를 더하고 결과를 반환하는 작업을 수행한다.  
 

컴파일된 `code` 객체에는 다음과 같은 opcode 명령어가 포함된다.

1.  `LOAD_CONST` - `2`를 스택에 올림.
2.  `STORE_NAME` - `a`라는 이름에 스택의 값을 할당.
3.  `LOAD_CONST` - `3`을 스택에 올림.
4.  `STORE_NAME` - `b`라는 이름에 스택의 값을 할당.
5.  `LOAD_NAME` - `a`라는 이름에 해당하는 값을 스택에 올림.
6.  `LOAD_NAME` - `b`라는 이름에 해당하는 값을 스택에 올림.
7.  `BINARY_ADD` - 스택에서 두 값을 꺼내어 더한 후 결과를 다시 스택에 저장.
8.  `STORE_NAME` - `c`라는 이름에 스택의 값을 할당.
9.  `LOAD_NAME` - `c`라는 이름에 해당하는 값을 스택에 올림.
10. `PRINT_ITEM` - 스택에서 값을 꺼내어 출력.
11. `PRINT_NEWLINE` - 새로운 줄을 출력.

   
따라서 파이썬 가상 머신은 PyCodeObject에서 opcode를 가져오고 해당 코드를 실행하여 우리가 작성한 파이썬 코드를 실제로 실행시키는 역할을 한다.  
 

# 왜 알아야 할까?

파이썬 VM의 구조를 이해하면, 파이썬 프로그래밍에서의 _성능 최적화, 파이썬 라이브러리 내부 동작 방식의 이해, 파이썬 인터프리터의 디버깅 방법 등 다양한 측면에서 도움_이 된다고 한다.

1.  데이터 사이언스 업계에서는 대용량 데이터 처리, 머신러닝 모델의 학습 및 추론, 자연어 처리, 이미지 처리 등의 작업에 파이썬을 사용하고 있다. 이러한 작업은 데이터의 크기와 복잡도가 매우 크기 때문에 성능 최적화가 필수다. 따라서 이러한 작업들에서 파이썬 코드를 더 효율적으로 작성하고 실행하기 위해서는 파이썬 VM에 대한 이해가 필요하다.
2.  파이썬 라이브러리들은 매우 복잡한 내부 구조를 가지고 있으며, 이를 이해하려면 파이썬 VM의 구조를 이해해야 한다. 예를 들어, NumPy, Pandas, TensorFlow와 같은 라이브러리는 대용량 데이터 처리를 위한 내부 최적화와 병렬 처리 기능을 제공하는데, 이러한 기능은 파이썬 VM의 이해에 기반하여 구현된다고 한다.
3.  파이썬 인터프리터의 디버깅은 코드를 실행하면서 발생하는 문제를 찾는 데 매우 중요하다. 파이썬 VM의 동작 방식을 이해할 수 있다면 코드 실행 과정에서 발생하는 문제를 빠르게 파악하고 해결할 수 있다고 한다.

## 좋은 예시 1. 효율적 코딩

파이썬에서는 변수의 할당 및 해제를 자동으로 처리한다. 이를 "**Garbage Collection**"이라고 부른다. 하지만 이 과정에서도 메모리 누수가 발생한다. 따라서 코드에서는 가능한 적은 변수를 사용하고, 불필요한 변수는 빨리 해제하여 메모리 누수를 최소화하는 것이 중요합니다.  
   
또한, 파이썬은 동적 타입 언어이기 때문에 변수의 타입을 명시적으로 지정하지 않습니다. 이러한 특성 때문에 코드의 가독성이 떨어지고, 런타임 시에 타입 에러가 발생할 수 있다. 따라서 변수의 타입을 명시적으로 지정하고, 불필요한 형변환을 피하는 등의 방법으로 코드의 효율성을 높일 수 있습니다.  
   
예를 들어, 다음은 리스트를 반복문을 사용하여 생성하는 코드입니다.

```python
lst = []
for i in range(10):
    lst.append(i)
```

   
하지만 다음과 같이 리스트 컴프리헨션(함수형 언어 방식)으로 작성하면 코드를 간단하게 작성할 수 있다.

```python
lst = [i for i in range(10)]
```

   
이렇게 간단한 코드 작성 방법을 사용하면 변수 할당 및 해제 등 불필요한 형변환 등을 줄이고 코드의 가독성과 성능을 향상시킬 수 있다.  
 

## 좋은 예시 2. 라이브러리

1.  NumPy는 파이썬의 리스트보다 대규모 데이터를 처리할 때 더 빠른 속도를 보여주는데, 이는 NumPy가 내부적으로 C로 구현되어 있기 때문이다. 이러한 구현은 NumPy 배열이 파이썬 리스트보다 더 적은 오버헤드를 가지기 때문이며, 이를 통해 메모리 사용량과 실행 시간을 줄일 수 있다.  
      
    
2.  Pandas는 대용량 데이터 프레임 처리를 위해 Cython과 같은 언어를 사용하여 내부적으로 구현되어 있다. 이러한 구현은 Pandas가 빠른 속도로 데이터 프레임을 처리할 수 있도록 하며, 이를 통해 데이터 분석 작업의 효율성을 높일 수 있다.  
    CPython이 내부적으로 구현되어 있다는 말은, Pandas가 Python 코드와 같은 고수준의 인터페이스를 제공하면서도, 실제로 데이터 처리와 같은 작업을 수행할 때는 CPython과 같은 저수준의 언어로 작성된 코드를 사용한다는 것을 의미한다. 이를 통해 Pandas는 Python 언어의 편리한 문법과 C 언어의 빠른 처리 속도를 모두 활용할 수 있다.  
    Pandas에서는 대용량 데이터 처리를 위해 Cython과 같은 언어를 사용해 내부에서 구현을 최적화한다. Cython은 Python 프로그램을 C 확장으로 변환하기 위한 도구이며, Python 코드를 C 코드로 변환하여 실행 속도를 향상시키는 역할을 한다. 이는 Pandas에서도 마찬가지. Pandas는 Cython으로 작성된 코드를 사용하여 대용량 데이터 프레임을 처리한다. Cython 코드는 CPython 인터프리터에서 직접 실행할 수 있으며, 이를 통해 Pandas는 빠른 속도로 데이터 프레임을 처리할 수 있게 된다.  
    Pandas의 dataframe과 series는 Cython 코드로 구현되어 있다. Pandas의 method로 알고 있는 sum() 함수도 Cython 코드로 작성되어 있으며, 이 함수는 dataframe과 series에서 사용되는데 이렇게 Pandas의 Cython 코드가 데이터 프레임과 시리즈와 같은 데이터 구조로 연결되어 있는 것. 이를 통해서 Pandas는 빠른 속도로 대용량 데이터를 처리할 수 있게 된다.
3.  TensorFlow는 GPU를 사용하여 대규모 수치 계산을 병렬 처리한다. 이는 TensorFlow가 내부적으로 C++로 구현되어 있기 때문이며, 이러한 구현은 TensorFlow가 파이썬 VM의 제약을 벗어나 더욱 빠른 계산을 수행할 수 있도록 해준다.

   
따라서, 파이썬 VM의 이해는 이러한 라이브러리들의 내부 최적화와 병렬 처리 기능을 이해하는 데 중요하며, 이러한 라이브러리들을 사용할 때 파이썬 코드를 어떻게 작성해야 하는지에 대한 인사이트를 제공한다.  
 

### Numpy 예시

파이썬 코드를 NumPy 배열과 같은 대규모 데이터 구조로 변환하여 처리하면 실행 시간을 줄일 수 있다.  
   
예를 들어, 파이썬의 기본 **리스트(List)는 포인터 배열이며, 요소가 변경될 때마다 새로운 메모리를 할당하고 복사하기 때문에 많은 양의 데이터를 처리할 때는 매우 느리다**. 하지만 NumPy의 배열은 메모리 블록으로 구현되며, 데이터 요소가 연속적으로 배치되어 있어 메모리 할당 및 복사를 최소화하고 대량의 데이터를 효율적으로 처리할 수 있다.  
   
아래는 파이썬 리스트와 NumPy 배열을 사용하여 벡터 간의 연산을 수행하는 코드 예시이다.

```python
import numpy as np

# Python List로 벡터 연산
a = [1, 2, 3]
b = [4, 5, 6]

c = []
for i in range(len(a)):
    c.append(a[i] + b[i])

print(c)  # [5, 7, 9]

# NumPy Array로 벡터 연산
a = np.array([1, 2, 3])
b = np.array([4, 5, 6])

c = a + b

print(c)  # [5 7 9]
```

   
위 코드에서 볼 수 있듯이, NumPy 배열을 사용하면 파이썬 리스트에 비해 코드가 훨씬 간결하고 읽기 쉽다. 또한, 벡터 연산은 NumPy에서 내부적으로 구현되어 있어 빠르게 처리된다. 따라서 대규모 데이터를 처리해야 하는 경우에는 NumPy 배열을 사용하는 것이 효율적이다.  
   
데이터 분석 작업에서도 이와 같이 Pandas 데이터 프레임을 사용하면 더욱 높은 효율성을 달성할 수 있다는 것을 이해할 수 있다.  
 

### TensorFlow 예시

TensorFlow는 기본적으로 그래프 형태의 계산을 빠르게 수행하기 위해 내부가 C++로 구현되어 있다. 이러한 방식은 TensorFlow가 파이썬 VM 구조보다 더 빠른 계산을 수행할 수 있도록 만들어 준다.  
   
예를 들어,

```python
import tensorflow as tf

# 상수 텐서를 생성.
a = tf.constant(5.0)
b = tf.constant(6.0)

# 덧셈 연산을 정의.
c = a + b

# 세션을 생성하고 연산을 실행.
with tf.Session() as sess:
    print(sess.run(c))
```

이 코드에서 `a`, `b`, `c`는 모두 TensorFlow의 텐서(Tensor) 객체다. 이 텐서 객체들은 내부적으로 C++ 코드로 구현되어 있으며, 파이썬 VM의 제약을 벗어나 빠른 계산을 수행할 수 있다.

또한, `tf.Session()`을 사용하여 세션(Session)을 생성하고 `sess.run()` 메서드를 사용하여 연산을 실행하는데, 이러한 연산 역시 내부적으로 C++ 코드로 구현되어 있다.

   
GPU를 사용해서 대규모 계산은 병렬 처리하는데, 이 또한 C++ 코드로 구현되어 있다. 이러한 방식은 TensorFlow가 GPU를 활용하여 더욱 빠른 계산을 수행할 수 있도록 도와준다.  
   
예를 들어,

```python
import tensorflow as tf
import numpy as np

# 두 개의 랜덤 행렬을 생성.
a = np.random.rand(1000, 1000)
b = np.random.rand(1000, 1000)

# 행렬 곱셈 연산을 정의.
input_a = tf.placeholder(tf.float32, shape=[1000, 1000])
input_b = tf.placeholder(tf.float32, shape=[1000, 1000])
output = tf.matmul(input_a, input_b)

# 세션을 생성하고 연산을 실행.
with tf.Session() as sess:
    print(sess.run(output, feed_dict={input_a: a, input_b: b}))
```

이 코드에서 `input_a`, `input_b`, `output`는 모두 TensorFlow의 텐서(Tensor) 객체다.

`tf.placeholder()` 메서드를 사용하여 입력값의 형태를 정의하고 `tf.matmul()` 메서드를 사용하여 두 개의 행렬을 곱하는 연산을 정의하는 것도 내부적으로 C++ 코드로 구현되어 있다. 또한, `sess.run()` 메서드를 사용하여 TensorFlow 그래프를 실행하고 그 결과를 얻는다.

   
이러한 실행은 내부적으로 C++ runtime에서 수행되는데 TensorFlow의 runtime은 텐서들 간의 연산을 구현한 C++ 코드를 실행하고, 이를 통해 텐서 계산을 병렬 처리하며 빠른 결과를 반환한다.  
 

## 좋은 예시 3. 디버깅

   
코드가 실행되는 도중 에러가 발생한다면 이를 빠르게 파악하고 해결할 수 있어야 한다. 파이썬 VM에 대한 이해를 한다면 이 부분에서도 도움이 된다고 한다.  
   
파이썬 VM의 동작 방식을 이해한다는 것은 코드 실행 과정에서 어떤 일이 일어나는지 이해하는 것을 말한다. 예를 들어, 코드가 실행될 때 스택 프레임이 어떻게 구성되는지, 함수가 호출될 때 어떤 일이 일어나는지 등을 이해한다면 코드 실행 과정에서 발생하는 문제를 더 쉽게 파악할 수 있다.  
   
예를 들어,

```python
def calculate_sum(a, b):
    c = a + b
    d = b * 2
    e = c / d
    return e

result = calculate_sum(10, 5)
```

위 코드에서는 `calculate_sum()` 함수가 호출되며, 함수 내부에서는 세 개의 변수 `c`, `d`, `e`가 생성되어 계산되고, 최종적으로 `e` 값이 반환된다. 만약 `calculate_sum()` 함수에서 잘못된 값을 반환한다면, 디버깅 과정에서 파이썬 VM의 동작 방식에 대한 이해가 도움이 될 수 있다.

파이썬 VM은 함수 호출 스택을 사용하여 함수 호출을 관리한다. 따라서 위 코드에서 `calculate_sum()` 함수가 호출될 때, 함수 호출 스택에 해당 함수가 추가되고, 함수가 실행되면서 변수 `c`, `d`, `e`가 생성되고 값이 할당된다. 디버깅 과정에서는 이러한 함수 호출 스택과 변수 값의 변화를 파악하여 코드 실행 결과의 예상치 못한 부분을 찾아내고 수정할 수 있다.

잘못된 값이 반환된다면, 디버깅 과정에서 함수 호출 스택을 살펴보고, 변수 `c`, `d`, `e`의 값을 확인하여 문제의 원인을 찾아내고 코드를 수정할 수 있다. 이러한 과정에 도움이 되기에 파이썬 VM의 동작 방식을 이해하는 것이 도움이 된다.
